<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Performance Event Monitoring - running-ng Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../install.html"><strong aria-hidden="true">1.1.</strong> Installation</a></li></ol></li><li class="chapter-item expanded "><a href="../quickstart.html"><strong aria-hidden="true">2.</strong> Quickstart</a></li><li class="chapter-item expanded "><a href="../basics/index.html"><strong aria-hidden="true">3.</strong> Basics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../basics/design.html"><strong aria-hidden="true">3.1.</strong> Design Principles</a></li></ol></li><li class="chapter-item expanded "><a href="../references/index.html"><strong aria-hidden="true">4.</strong> Core References</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../references/suite.html"><strong aria-hidden="true">4.1.</strong> Benchmark Suite</a></li><li class="chapter-item expanded "><a href="../references/runtime.html"><strong aria-hidden="true">4.2.</strong> Runtime</a></li><li class="chapter-item expanded "><a href="../references/modifier.html"><strong aria-hidden="true">4.3.</strong> Modifier</a></li></ol></li><li class="chapter-item expanded "><a href="../commands/index.html"><strong aria-hidden="true">5.</strong> Command References</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../commands/runbms.html"><strong aria-hidden="true">5.1.</strong> runbms</a></li><li class="chapter-item expanded "><a href="../commands/minheap.html"><strong aria-hidden="true">5.2.</strong> minheap</a></li><li class="chapter-item expanded "><a href="../commands/fillin.html"><strong aria-hidden="true">5.3.</strong> fillin</a></li></ol></li><li class="chapter-item expanded "><a href="../cookbook/index.html"><strong aria-hidden="true">6.</strong> Cookbook</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cookbook/perf_events.html" class="active"><strong aria-hidden="true">6.1.</strong> Performance Event Monitoring</a></li></ol></li><li class="chapter-item expanded "><a href="../faq.html"><strong aria-hidden="true">7.</strong> Frequently Asked Questions</a></li><li class="chapter-item expanded "><a href="../changelog.html"><strong aria-hidden="true">8.</strong> Changelog</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">running-ng Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="whole-process-performance-event-monitoring"><a class="header" href="#whole-process-performance-event-monitoring">Whole-Process Performance Event Monitoring</a></h1>
<h2 id="jvmti"><a class="header" href="#jvmti">JVMTI</a></h2>
<p>Please clone and build <a href="../quickstart.html#prepare-probes"><code>probes</code></a>, and then build <a href="https://github.com/caizixian/distillation"><code>distillation</code></a>.
You might need to change the paths referred in the <code>Makefile</code>s to match your environment.</p>
<p>Under the <code>distillation</code> folder, you will find a JVMTI agent, <code>libperf_statistics.so</code>.
You can check the source code <a href="https://github.com/caizixian/distillation/blob/master/perf_statistics.c">here</a>.
To use the agent, there are four things you need to do.</p>
<p>First, you will need to tell the dynamic linker to load the shared library before the VM boots.
This ensures that the <code>inherit</code> flag of <code>perf_event_attr</code> works properly and all child threads subsequently spawned are included in the results.</p>
<pre><code class="language-yaml">modifiers:
  jvmti_env:
    type: EnvVar
    var: &quot;LD_PRELOAD&quot;
    val: &quot;/path/to/distillation/libperf_statistics.so&quot;
</code></pre>
<p>Second, you need to specify a list of events you want to measure.</p>
<pre><code class="language-yaml">modifiers:
  perf:
    type: EnvVar
    var: &quot;PERF_EVENTS&quot;
    val: &quot;PERF_COUNT_HW_CPU_CYCLES,PERF_COUNT_HW_INSTRUCTIONS,PERF_COUNT_HW_CACHE_LL:MISS,PERF_COUNT_HW_CACHE_L1D:MISS,PERF_COUNT_HW_CACHE_DTLB:MISS&quot;
</code></pre>
<p>If you want to get a full list of events you can use on a particular machine, you can clone and build <a href="https://sourceforge.net/p/perfmon2/libpfm4/ci/master/tree/"><code>libpfm4</code></a> and run the <code>showevtinfo</code> <a href="https://sourceforge.net/p/perfmon2/libpfm4/ci/master/tree/examples/showevtinfo.c">program</a>.</p>
<p>Third, you need to tell the JVM to load the agent.
Note that you need to specify the absolute path.</p>
<pre><code class="language-yaml">modifiers:
  jvmti:
    type: JVMArg
    val: &quot;-agentpath:/path/to/distillation/libperf_statistics.so&quot;
</code></pre>
<p>Finally, you need to let the DaCapo benchmark inform the start and the end of a benchmark iteration.
We will reuse the <code>RustMMTk</code> probe here, as the callback functions in the JVMTI agent are also called <code>harness_begin</code> and <code>harness_end</code>.</p>
<pre><code class="language-yaml">modifiers:
  probes_cp:
    type: JVMClasspath
    val: &quot;/path/to/probes/out /path/to/probes/out/probes.jar&quot;
  probes:
    type: JVMArg
    val: &quot;-Djava.library.path=/path/to/probes/out -Dprobes=RustMMTk&quot;
</code></pre>
<p>Now, putting it all together, you can define a set of modifiers, and use that set in your config strings.</p>
<pre><code class="language-yaml">modifiers:
  jvmti_common:
    type: ModifierSet
    val: &quot;probes|probes_cp|jvmti|jvmti_env|perf&quot;
</code></pre>
<h2 id="mmtk"><a class="header" href="#mmtk">MMTk</a></h2>
<p>Please clone and build <a href="../quickstart.html#prepare-probes"><code>probes</code></a>.
You will need to build <code>mmtk-core</code> with the <code>perf_counter</code> feature.</p>
<p>First, you need to let the DaCapo benchmark inform the start and the end of a benchmark iteration.</p>
<pre><code class="language-yaml">modifiers:
  probes_cp:
    type: JVMClasspath
    val: &quot;/path/to/probes/out /path/to/probes/out/probes.jar&quot;
  probes:
    type: JVMArg
    val: &quot;-Djava.library.path=/path/to/probes/out -Dprobes=RustMMTk&quot;
</code></pre>
<p>Then, you can specify a list of events you want to measure.</p>
<pre><code class="language-yaml">modifiers:
  mmtk_perf:
    type: EnvVar
    var: &quot;MMTK_PHASE_PERF_EVENTS&quot;
    val: &quot;PERF_COUNT_HW_CPU_CYCLES,0,-1;PERF_COUNT_HW_INSTRUCTIONS,0,-1;PERF_COUNT_HW_CACHE_LL:MISS,0,-1;PERF_COUNT_HW_CACHE_L1D:MISS,0,-1;PERF_COUNT_HW_CACHE_DTLB:MISS,0,-1&quot;
</code></pre>
<p>Note that the list is semicolon-separated.
Each entry consists of three parts, separated by commas.
The first part is the name of the event.
Please refer to the previous section for details.
The second part and the third part are <code>pid</code> and <code>cpu</code>, per <code>man perf_event_open</code>.
In most cases, you want to use <code>0,-1</code>, that is measuring the calling thread (the results will be combined later through the <code>inherit</code> flag) on any CPU.
For some events, such as RAPL, only package-wide measurement is supported, and you will have to adjust the values accordingly.</p>
<p><strong>Note that you might have to increase the value of <code>MAX_PHASES</code> in <code>crate::util::statistics::stats</code> to a larger value, e.g., <code>1 &lt;&lt; 14</code>, so that the array storing the per-phase value will not overflow.</strong></p>
<h1 id="work-packet-performance-event-monitoring"><a class="header" href="#work-packet-performance-event-monitoring">Work-Packet Performance Event Monitoring</a></h1>
<p>It's similar to the whole-process performance event monitoring for MMTk.
Just use <code>MMTK_WORK_PERF_EVENTS</code> instead of <code>MMTK_PHASE_PERF_EVENTS</code>.</p>
<h1 id="machine-specific-known-problems"><a class="header" href="#machine-specific-known-problems">Machine-Specific Known Problems</a></h1>
<p>On Xeon D-1540 Broadwell, the <code>PERF_COUNT_HW_CACHE_LL:MISS</code> event is always zero.</p>
<pre><code class="language-console">perf stat -e LLC-load-misses,cycles /bin/ls

 Performance counter stats for '/bin/ls':

                 0      LLC-load-misses
         1,729,786      cycles

       0.001135511 seconds time elapsed

       0.001180000 seconds user
       0.000000000 seconds sys
</code></pre>
<p>On AMD machines, the <code>PERF_COUNT_HW_CACHE_LL:MISS</code> event fails to open.
<code>perf_event_open</code> syscall fails with <code>No such file or directory</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../cookbook/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../faq.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../cookbook/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../faq.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
